<!-- templates/maintenance_dashboard.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Maintenance Dashboard</title>
  <link rel="icon" href="{{ url_for('static', filename='images/web_icon.png') }}">

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --primary: #28a745;
      --primary-bg: rgba(40, 167, 69, 0.1);
      --badge-bg: #6c757d;
      --light-gray: #f8f9fa;
      --text-dark: #333;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light-gray);
    }

    .header-banner {
      background: linear-gradient(to right, #2efef1, #ffffff);
      padding: 3rem 1rem;
      text-align: center;
    }

    .header-banner h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: .5rem;
      color: #000;
    }

    .header-banner p {
      font-size: 1.1rem;
      color: #444;
    }

    .issues-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      padding: 2rem;
    }

    .issue-card {
      background: #fff;
      border-radius: .5rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: transform 0.2s ease;
    }

    .issue-card:hover {
      transform: translateY(-4px);
    }

    .issue-icon {
      font-size: 2.5rem;
      color: var(--primary);
      width: 60px;
      height: 60px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: var(--primary-bg);
      margin-bottom: .75rem;
    }

    .issue-title {
      font-weight: 600;
      margin-bottom: .25rem;
      font-size: 1.1rem;
    }

    .issue-subtitle {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    .btn-outline-success {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-outline-success:hover {
      background: var(--primary);
      color: #fff;
    }

    .badge-completed,
    .badge-pending,
    .badge-awaiting {
      background: var(--badge-bg);
      color: #fff;
      border-radius: 1rem;
      padding: .5rem 1rem;
      font-size: .85rem;
      margin-top: auto;
    }

    .status-form {
      margin-top: auto;
    }

    .status-form .form-select {
      max-width: 140px;
    }

    .modal-detail .modal-content {
      border-radius: .75rem;
      overflow: hidden;
    }

    .detail-icon {
      font-size: 2rem;
      color: var(--primary);
      width: 100px;
      height: 100px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: var(--primary-bg);
      margin: 0 auto 1rem;
    }

    .detail-title {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .detail-description {
      font-size: .95rem;
      color: var(--text-dark);
      margin-bottom: 1.5rem;
    }

    .detail-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      align-items: start;
    }

    .map-item,
    .img-item {
      background: #fff;
      border-radius: .5rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 350px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .map-container {
      flex: 1;
      width: 100%;
      height: 100%;
    }

    .img-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .detail-item-label {
      padding: .5rem;
      text-align: center;
      font-weight: 600;
      color: #444;
    }

    .map-item a {
      padding: .5rem;
      color: #007bff;
      text-decoration: none;
    }

    .close-btn {
      background: #000;
      color: #fff;
      border-radius: 2rem;
      padding: .5rem 1.5rem;
      border: none;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="{{ url_for('main.home') }}">
        <img src="{{ url_for('static', filename='images/cityfixlogo.png') }}" width="30" height="30" alt="CityFix Logo"
          class="d-inline-block align-text-top" />
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.profile') }}">Profile</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('reports.report_issue') }}"><i
                class="bi bi-plus-circle-fill"></i> Report Issue</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('reports.rejected_reports') }}"><i
                class="bi bi-envelope-exclamation-fill"></i> Rejections</a></li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.logout') }}"><i
                class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <section class="header-banner">
    <h1>Welcome, {{ user.name }}!</h1>
    <p>Your Assigned Issues</p>
  </section>

  <!-- Issues Grid -->
  <section class="issues-grid">
    {% for issue in issues %}
    {% set cat = issue.category|lower %}
    {% set icon = 'exclamation-circle-fill' %}
    {% if cat=='traffic light failure'%}{% set icon='traffic-light-fill'%}
    {% elif cat=='water leak'%}{% set icon='droplet-fill'%}
    {% elif cat=='road closure'%}{% set icon='road-closed'%}
    {% elif cat=='power cut'%}{% set icon='bolt-fill'%}
    {% elif cat=='hole in the road'%}{% set icon='slash-circle-fill'%}{% endif %}

    <div class="issue-card">
      <div class="issue-icon"><i class="bi bi-{{ icon }}"></i></div>
      <div class="issue-title">{{ issue.category|replace('_',' ') }}</div>
      <div class="issue-subtitle">See what happens</div>
      <button class="btn btn-outline-success mb-2" data-bs-toggle="modal"
        data-bs-target="#detailModal{{ issue._id }}">Details</button>

      {% if issue.status=='pending' %}
      <span class="badge-pending">Pending</span>
      {% elif issue.awaiting %}
      <span class="badge-awaiting">Awaiting Approval</span>
      {% elif issue.status=='done' %}
      <span class="badge-completed">Completed</span>
      {% else %}
      <form class="status-form" action="{{ url_for('reports.maintenance_update_status', issue_id=issue._id) }}"
        method="POST">
        <div class="input-group">
          <select name="status" class="form-select status-select">
            <option value="in progress" {% if issue.status=='in progress' %}selected{% endif %}>In Progress</option>
            <option value="done" {% if issue.status=='done' %}selected{% endif %}>Done</option>
          </select>
          <button type="button" class="btn btn-success btn-update" data-issue-id="{{ issue._id }}">Update</button>
        </div>
      </form>
      {% endif %}
    </div>
    {% endfor %}
  </section>

  <!-- Completion Modals -->
  {% for issue in issues %}
  <div class="modal fade" id="completionModal{{ issue._id }}" tabindex="-1">
    <div class="modal-dialog">
      <form action="{{ url_for('reports.maintenance_complete_issue', issue_id=issue._id) }}" method="POST"
        enctype="multipart/form-data" class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">Work Completion Report</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-start">
          <div class="mb-3">
            <label class="form-label">Detailed Description</label>
            <textarea name="completion_description" class="form-control" rows="4" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Before Photo</label>
            <input type="file" name="before_image" accept="image/*" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">After Photo</label>
            <input type="file" name="after_image" accept="image/*" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}

  <!-- Detail Modals -->
  {% for issue in issues %}
  <div class="modal fade modal-detail" id="detailModal{{ issue._id }}" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          {% set cat = issue.category|lower %}
          {% if cat == 'traffic light failure' %}{% set icon = 'traffic-light-fill' %}
          {% elif cat == 'water leak' %}{% set icon = 'droplet-fill' %}
          {% elif cat == 'road closure' %}{% set icon = 'road-closed' %}
          {% elif cat == 'power cut' %}{% set icon = 'bolt-fill' %}
          {% elif cat == 'hole in the road' %}{% set icon = 'slash-circle-fill' %}
          {% else %}{% set icon = 'exclamation-circle-fill' %}{% endif %}
          <div class="detail-icon"><i class="bi bi-{{ icon }}"></i></div>
          <div class="detail-title">{{ issue.category }}</div>
          <div class="detail-description"><strong>Description of the Issue:</strong><br>{{ issue.description }}</div>
          <div class="detail-grid">
            <div class="map-item">
              <div id="map{{ issue._id }}" class="map-container" data-lat="{{ issue.location.lat }}"
                data-lng="{{ issue.location.lng }}"></div>
              <a href="https://maps.google.com/?q={{ issue.location.lat }},{{ issue.location.lng }}"
                target="_blank">View on Map</a>
            </div>
            {% if issue.image_file_id %}
            <div class="img-item">
              <img src="{{ url_for('reports.serve_upload', file_id=issue.image_file_id) }}" alt="Problem Image" />
              <div class="detail-item-label">Problem</div>
            </div>
            {% endif %}
          </div>
          <div class="text-end mt-4"><button class="close-btn" data-bs-dismiss="modal">Close</button></div>
        </div>

      </div>
    </div>
  </div>
  {% endfor %}

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // configure Leaflet icons
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
      iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
    });
    const maps = {};
    document.querySelectorAll('.modal-detail').forEach(modalEl => {
      modalEl.addEventListener('shown.bs.modal', () => {
        const id = modalEl.id.replace('detailModal', '');
        const div = document.getElementById('map' + id);
        if (!maps[id]) {
          const lat = parseFloat(div.dataset.lat);
          const lng = parseFloat(div.dataset.lng);
          const map = L.map(div).setView([lat, lng], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
          L.marker([lat, lng]).addTo(map);
          setTimeout(() => map.invalidateSize(), 200);
          maps[id] = map;
        } else {
          maps[id].invalidateSize();
        }
      });
    });
    document.querySelectorAll('.btn-update').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.issueId;
        const form = document.querySelector(`form[action*='${id}']`);
        const select = form.querySelector('.status-select');
        if (select.value === 'done') {
          bootstrap.Modal.getOrCreateInstance(document.getElementById('completionModal' + id)).show();
        } else {
          form.submit();
        }
      });
    });
  </script>
</body>

</html>