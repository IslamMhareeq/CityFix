<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Maintenance Dashboard - {{ user.name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='images/web_icon.png') }}">

  <meta name="description" content="Manage assigned maintenance tasks and work orders in CityFix.">

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard.css') }}">

  <style>
    .maintenance-hero {
      background: linear-gradient(135deg, var(--emerald-500), var(--primary-500));
      color: white;
      padding: var(--space-16) 0 var(--space-20);
      position: relative;
      overflow: hidden;
    }

    .maintenance-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="tools-pattern" width="50" height="50" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="3" fill="white" opacity="0.1"/><path d="M15 15l10 10M35 15l10 10" stroke="white" stroke-width="1" opacity="0.05"/><circle cx="10" cy="40" r="1" fill="white" opacity="0.08"/></pattern></defs><rect width="100" height="100" fill="url(%23tools-pattern)"/></svg>');
      opacity: 0.3;
    }

    .maintenance-content {
      position: relative;
      z-index: 1;
      text-align: center;
    }

    .maintenance-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid rgba(255, 255, 255, 0.3);
      box-shadow: var(--shadow-2xl);
      margin: 0 auto var(--space-6);
      background: linear-gradient(135deg, var(--emerald-300), var(--primary-300));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-3xl);
      font-weight: 700;
      color: white;
    }

    .maintenance-greeting {
      font-size: var(--text-4xl);
      font-weight: 800;
      margin-bottom: var(--space-2);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .maintenance-subtitle {
      font-size: var(--text-xl);
      opacity: 0.9;
      margin-bottom: var(--space-8);
    }

    .maintenance-stats {
      display: flex;
      justify-content: center;
      gap: var(--space-8);
      flex-wrap: wrap;
    }

    .maintenance-stat {
      text-align: center;
    }

    .maintenance-stat-number {
      font-size: var(--text-3xl);
      font-weight: 800;
      display: block;
      margin-bottom: var(--space-2);
    }

    .maintenance-stat-label {
      font-size: var(--text-sm);
      opacity: 0.9;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .dashboard-content {
      margin-top: calc(-1 * var(--space-12));
      position: relative;
      z-index: 2;
    }

    .dashboard-header {
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--gray-200);
      padding: var(--space-6) var(--space-8);
      margin-bottom: var(--space-8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: var(--space-4);
    }

    .dashboard-title {
      font-size: var(--text-2xl);
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .dashboard-title i {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--emerald-100);
      color: var(--emerald-600);
      border-radius: var(--radius-xl);
      font-size: var(--text-lg);
    }

    .dashboard-actions {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .btn-action {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-xl);
      font-weight: 600;
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
      text-decoration: none;
      border: none;
    }

    .btn-action:hover {
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary-action {
      background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600));
      color: white;
    }

    .btn-primary-action:hover {
      background: linear-gradient(135deg, var(--emerald-600), var(--emerald-700));
      color: white;
    }

    .btn-secondary-action {
      background: var(--gray-100);
      color: var(--text-secondary);
      border: 2px solid var(--gray-300);
    }

    .btn-secondary-action:hover {
      background: var(--gray-200);
      color: var(--text-primary);
    }

    .tasks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: var(--space-6);
    }

    .task-card {
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      transition: var(--transition-all);
      position: relative;
    }

    .task-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--emerald-500);
    }

    .task-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-2xl);
    }

    .task-card.awaiting::before {
      background: var(--orange-500);
    }

    .task-card.rejected::before {
      background: var(--red-500);
    }

    .task-card.completed::before {
      background: var(--emerald-500);
    }

    .task-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .task-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .task-category {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .category-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
      flex-shrink: 0;
    }

    .category-traffic {
      background: var(--orange-100);
      color: var(--orange-600);
    }

    .category-water {
      background: var(--blue-100);
      color: var(--blue-600);
    }

    .category-power {
      background: var(--yellow-100);
      color: var(--yellow-600);
    }

    .category-road {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .category-default {
      background: var(--emerald-100);
      color: var(--emerald-600);
    }

    .category-name {
      font-weight: 700;
      color: var(--text-primary);
      font-size: var(--text-lg);
    }

    .task-priority {
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .priority-high {
      background: var(--red-100);
      color: var(--red-800);
    }

    .priority-medium {
      background: var(--orange-100);
      color: var(--orange-800);
    }

    .priority-low {
      background: var(--gray-100);
      color: var(--gray-800);
    }

    .task-description {
      color: var(--text-secondary);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .task-body {
      padding: var(--space-6);
    }

    .task-details {
      display: grid;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .detail-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .detail-icon {
      width: 20px;
      height: 20px;
      color: var(--text-muted);
      margin-top: 2px;
      flex-shrink: 0;
    }

    .detail-content {
      flex: 1;
      min-width: 0;
    }

    .detail-label {
      font-size: var(--text-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
      margin-bottom: var(--space-1);
    }

    .detail-value {
      color: var(--text-primary);
      font-weight: 500;
      word-break: break-word;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-pending {
      background: var(--gray-100);
      color: var(--gray-800);
    }

    .status-in-progress {
      background: var(--blue-100);
      color: var(--blue-800);
    }

    .status-awaiting {
      background: var(--orange-100);
      color: var(--orange-800);
    }

    .status-completed {
      background: var(--emerald-100);
      color: var(--emerald-800);
    }

    .status-rejected {
      background: var(--red-100);
      color: var(--red-800);
    }

    .rejection-notice {
      background: var(--red-50);
      border: 1px solid var(--red-200);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .rejection-title {
      font-weight: 700;
      color: var(--red-800);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .rejection-reason {
      color: var(--red-700);
      font-size: var(--text-sm);
    }

    .task-actions {
      padding: var(--space-6);
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .status-form {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .status-select {
      flex: 1;
      padding: var(--space-3);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      background: white;
      color: var(--text-primary);
      transition: var(--transition-all);
    }

    .status-select:focus {
      outline: none;
      border-color: var(--emerald-500);
      box-shadow: 0 0 0 3px var(--emerald-100);
    }

    .btn-update {
      padding: var(--space-3) var(--space-6);
      background: var(--emerald-500);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-all);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      white-space: nowrap;
    }

    .btn-update:hover {
      background: var(--emerald-600);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .action-buttons {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .btn-details {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: var(--primary-100);
      color: var(--primary-700);
      border: 2px solid var(--primary-200);
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
      text-decoration: none;
    }

    .btn-details:hover {
      background: var(--primary-200);
      color: var(--primary-800);
      text-decoration: none;
      transform: translateY(-1px);
    }

    .btn-complete {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: var(--emerald-500);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }

    .btn-complete:hover {
      background: var(--emerald-600);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-20) var(--space-6);
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }

    .empty-state i {
      font-size: var(--text-6xl);
      margin-bottom: var(--space-6);
      opacity: 0.3;
      color: var(--emerald-400);
    }

    .empty-state h3 {
      font-size: var(--text-2xl);
      font-weight: 700;
      margin-bottom: var(--space-3);
      color: var(--text-secondary);
    }

    .empty-state p {
      color: var(--text-muted);
      font-size: var(--text-lg);
      max-width: 400px;
      margin: 0 auto;
    }

    /* Modals */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-all);
    }

    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-2xl);
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
      transform: scale(0.9);
      transition: var(--transition-all);
    }

    .modal-backdrop.show .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--gray-50);
    }

    .modal-title {
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: var(--text-xl);
      cursor: pointer;
      color: var(--text-muted);
      padding: var(--space-2);
      border-radius: var(--radius-lg);
      transition: var(--transition-colors);
    }

    .btn-close:hover {
      color: var(--text-primary);
      background: var(--gray-200);
    }

    .modal-body {
      padding: var(--space-6);
    }

    .modal-footer {
      padding: var(--space-6);
      border-top: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: var(--space-3);
      background: var(--gray-50);
    }

    /* Google Maps Button Styles */
    .google-maps-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      width: 100%;
      padding: var(--space-3) var(--space-4);
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      text-decoration: none;
      border-radius: var(--radius-xl);
      font-weight: 600;
      font-size: var(--text-sm);
      transition: var(--transition-all);
      border: none;
      cursor: pointer;
    }

    .google-maps-btn:hover {
      background: linear-gradient(135deg, #3367d6, #2d8f47);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      text-decoration: none;
      color: white;
    }

    .directions-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      width: 100%;
      padding: var(--space-3) var(--space-4);
      background: var(--gray-100);
      color: var(--text-primary);
      text-decoration: none;
      border-radius: var(--radius-xl);
      font-weight: 600;
      font-size: var(--text-sm);
      transition: var(--transition-all);
      border: 2px solid var(--gray-300);
      cursor: pointer;
    }

    .directions-btn:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      text-decoration: none;
      color: var(--text-primary);
    }

    .coordinates-display {
      text-align: center;
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-top: var(--space-2);
      padding: var(--space-2);
      background: var(--gray-50);
      border-radius: var(--radius-lg);
      border: 1px solid var(--gray-200);
    }

    .no-location-display {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      background: var(--gray-100);
      border-radius: var(--radius-lg);
      color: var(--text-muted);
      border: 2px dashed var(--gray-300);
    }

    @media (max-width: 768px) {
      .maintenance-hero {
        padding: var(--space-12) 0 var(--space-16);
      }

      .maintenance-avatar {
        width: 80px;
        height: 80px;
        font-size: var(--text-2xl);
      }

      .maintenance-greeting {
        font-size: var(--text-2xl);
      }

      .maintenance-subtitle {
        font-size: var(--text-base);
      }

      .maintenance-stats {
        gap: var(--space-6);
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        text-align: center;
      }

      .dashboard-actions {
        width: 100%;
        justify-content: center;
      }

      .tasks-grid {
        grid-template-columns: 1fr;
      }

      .status-form {
        flex-direction: column;
        align-items: stretch;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn-details,
      .btn-complete {
        justify-content: center;
      }

      .google-maps-btn,
      .directions-btn {
        padding: var(--space-4);
        font-size: var(--text-base);
      }

      .coordinates-display {
        font-size: var(--text-xs);
      }
    }

    /* Liquid Animation Brand Style */
    .navbar-brand-liquid {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: 26px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 8px 16px;
      border-radius: 12px;
    }

    .liquid-text {
      position: relative;
      color: white;
      z-index: 2;
      overflow: hidden;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .liquid-text::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981, #2563eb);
      z-index: -1;
      animation: liquid 4s ease-in-out infinite;
      border-radius: inherit;
    }

    @keyframes liquid {

      0%,
      100% {
        left: -100%;
        transform: skewX(0deg);
      }

      50% {
        left: 100%;
        transform: skewX(20deg);
      }
    }

    /* Hover Effects */
    .navbar-brand-liquid:hover {
      text-decoration: none;
      transform: scale(1.02);
    }

    .navbar-brand-liquid:hover .liquid-text::before {
      animation-duration: 1s;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .navbar-brand-liquid {
        font-size: 22px;
      }

      .liquid-text {
        padding: 10px 16px;
      }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="navbar-content">
          <a href="{{ url_for('main.home') }}" class="navbar-brand-liquid"> <span class="liquid-text">CityFix</span>
        </a>

        <ul class="navbar-nav">
          <li class="nav-item">
            <a href="{{ url_for('main.profile') }}" class="nav-link">
              <i class="bi bi-person-circle" aria-hidden="true"></i>
              <span>Profile</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('reports.report_issue') }}" class="nav-link">
              <i class="bi bi-plus-circle-fill" aria-hidden="true"></i>
              <span>Report Issue</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('reports.rejected_reports') }}" class="nav-link">
              <i class="bi bi-envelope-exclamation-fill" aria-hidden="true"></i> Rejections
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-primary">
              <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Maintenance Hero -->
  <section class="maintenance-hero">
    <div class="container">
      <div class="maintenance-content">
        <div class="maintenance-avatar">
          {{ user.name[0].upper() if user.name else 'M' }}
        </div>
        <h1 class="maintenance-greeting">Welcome, {{ user.name }}!</h1>
        <p class="maintenance-subtitle">
          You have {{ issues|length }} assigned task{{ '' if issues|length == 1 else 's' }}
        </p>

        <div class="maintenance-stats">
          <div class="maintenance-stat">
            <span class="maintenance-stat-number">{{ issues|selectattr('status', 'equalto', 'pending')|list|length
              }}</span>
            <span class="maintenance-stat-label">Pending</span>
          </div>
          <div class="maintenance-stat">
            <span class="maintenance-stat-number">{{ issues|selectattr('status', 'equalto', 'in progress')|list|length
              }}</span>
            <span class="maintenance-stat-label">In Progress</span>
          </div>
          <div class="maintenance-stat">
            <span class="maintenance-stat-number">{{ issues|selectattr('status', 'equalto', 'resolved')|list|length
              }}</span>
            <span class="maintenance-stat-label">Resolved</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard Content -->
  <main class="dashboard-content">
    <div class="container">
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <h2 class="dashboard-title">
          <i class="bi bi-tools" aria-hidden="true"></i>
          Assigned Tasks
        </h2>
        <div class="dashboard-actions">
          <a href="{{ url_for('reports.report_issue') }}" class="btn-action btn-primary-action">
            <i class="bi bi-plus-circle" aria-hidden="true"></i>
            Report Issue
          </a>
          <a href="{{ url_for('reports.rejected_reports') }}" class="btn-action btn-secondary-action">
            <i class="bi bi-envelope-exclamation" aria-hidden="true"></i>
            View Rejections
          </a>
        </div>
      </div>

      <!-- Tasks Grid -->
      {% if issues %}
      <div class="tasks-grid">
        {% for issue in issues %}
        <div
          class="task-card {{ 'awaiting' if issue.awaiting else 'rejected' if issue.rejection_reason else 'completed' if issue.status == 'done' }}">
          <!-- Task Header -->
          <div class="task-header">
            <div class="task-meta">
              <div class="task-category">
                {% set cat = issue.category|lower %}
                <div
                  class="category-icon category-{{ 'traffic' if cat == 'traffic light failure' else 'water' if cat == 'water leak' else 'power' if cat == 'power cut' else 'road' if cat == 'hole in the road' else 'default' }}">
                  <i class="bi bi-{{ 'traffic-light-fill' if cat == 'traffic light failure' else 'droplet-fill' if cat == 'water leak' else 'bolt-fill' if cat == 'power cut' else 'slash-circle-fill' if cat == 'hole in the road' else 'exclamation-circle-fill' }}"
                    aria-hidden="true"></i>
                </div>
                <div class="category-name">{{ issue.category.replace('_', ' ').title() if issue.category else 'General
                  Task' }}</div>
              </div>
              <div
                class="task-priority priority-{{ 'high' if issue.status == 'pending' else 'medium' if issue.status == 'in progress' else 'low' }}">
                {{ 'High' if issue.status == 'pending' else 'Medium' if issue.status == 'in progress' else 'Low' }}
              </div>
            </div>
            <div class="task-description">{{ issue.description }}</div>
          </div>

          <!-- Task Body -->
          <div class="task-body">
            {% if issue.rejection_reason %}
            <div class="rejection-notice">
              <div class="rejection-title">
                <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                Work Rejected
              </div>
              <div class="rejection-reason">{{ issue.rejection_reason }}</div>
            </div>
            {% endif %}

            <div class="task-details">
              <div class="detail-item">
                <i class="bi bi-geo-alt detail-icon" aria-hidden="true"></i>
                <div class="detail-content">
                  {% if issue.location and issue.location.lat and issue.location.lng %}
                  <div class="detail-label">Location</div>
                  <div class="detail-value">{{ issue.location.lat|round(4) }}, {{ issue.location.lng|round(4) }}</div>
                  {% else %}
                  <div class="detail-label">Location</div>
                  <div class="detail-value">Location not specified</div>
                  {% endif %}
                </div>
              </div>

              <div class="detail-item">
                <i class="bi bi-clock detail-icon" aria-hidden="true"></i>
                <div class="detail-content">
                  <div class="detail-label">Status</div>
                  <div class="detail-value">
                    <span
                      class="status-badge status-{{ issue.status.replace(' ', '-') if issue.status else 'pending' }}">
                      <i class="bi bi-{{ 'clock' if issue.status == 'pending' else 'hourglass-split' if issue.status == 'in progress' else 'check-circle' if issue.status == 'resolved' else 'clock' }}"
                        aria-hidden="true"></i>
                      {{ issue.status.title() if issue.status else 'Pending' }}
                      {% if issue.awaiting %}(Awaiting Approval){% endif %}
                    </span>
                  </div>
                </div>
              </div>

              {% if issue.image_file_id %}
              <div class="detail-item">
                <i class="bi bi-image detail-icon" aria-hidden="true"></i>
                <div class="detail-content">
                  <div class="detail-label">Issue Photo</div>
                  <div class="detail-value">
                    <img src="{{ url_for('reports.serve_upload', file_id=issue.image_file_id) }}" alt="Issue image"
                      style="width: 100%; max-width: 200px; height: 120px; object-fit: cover; border-radius: var(--radius-lg); cursor: pointer;"onclick="showImageModal('{{ url_for('reports.serve_upload', file_id=issue.image_file_id) }}')">
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Task Actions -->
          <div class="task-actions">
            {% if issue.status == 'done' %}
            <div class="status-badge status-completed" style="margin-bottom: var(--space-4);">
              <i class="bi bi-check-all" aria-hidden="true"></i>
              Work Completed
            </div>
            {% elif issue.awaiting %}
            <div class="status-badge status-awaiting" style="margin-bottom: var(--space-4);">
              <i class="bi bi-clock-history" aria-hidden="true"></i>
              Awaiting Admin Approval
            </div>
            {% else %}
            <form class="status-form" action="{{ url_for('reports.maintenance_update_status', issue_id=issue._id) }}"
              method="POST">
              <select name="status" class="status-select">
                <option value="in progress" {% if issue.status=='in progress' %}selected{% endif %}>In Progress</option>
                <option value="resolved" {% if issue.status=='resolved' %}selected{% endif %}>Resolved</option>
              </select>
              <button type="submit" class="btn-update">
                <i class="bi bi-check" aria-hidden="true"></i>
                Update Status
              </button>
            </form>
            {% endif %}

            <div class="action-buttons">
              <button class="btn-details" onclick="showTaskModal('{{ issue._id }}')">
                <i class="bi bi-eye" aria-hidden="true"></i>
                View Details
              </button>
              {% if issue.status not in ['done', 'awaiting'] %}
              <button class="btn-complete" onclick="showCompletionModal('{{ issue._id }}')">
                <i class="bi bi-check-circle" aria-hidden="true"></i>
                Mark Complete
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <i class="bi bi-tools" aria-hidden="true"></i>
        <h3>No Tasks Assigned</h3>
        <p>
          You don't have any assigned maintenance tasks at this time.
          New tasks will appear here when they're assigned to you.
        </p>
      </div>
      {% endif %}
    </div>
  </main>

  <!-- Task Detail Modals -->
  {% for issue in issues %}
  <div id="task-modal-{{ issue._id }}" class="modal-backdrop" onclick="closeModal('task-modal-{{ issue._id }}')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 900px;">
      <div class="modal-header">
        <h3 class="modal-title">Task Details</h3>
        <button class="btn-close" onclick="closeModal('task-modal-{{ issue._id }}')">
          <i class="bi bi-x-lg" aria-hidden="true"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="grid grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold mb-3">Issue Information</h4>
            <div class="space-y-3">
              <div>
                <span class="text-sm text-secondary font-semibold">Category:</span>
                <div>{{ issue.category.replace('_', ' ').title() if issue.category else 'General' }}</div>
              </div>
              <div>
                <span class="text-sm text-secondary font-semibold">Description:</span>
                <div>{{ issue.description }}</div>
              </div>
              <div>
                <span class="text-sm text-secondary font-semibold">Status:</span>
                <div>{{ issue.status.title() if issue.status else 'Pending' }}</div>
              </div>
              {% if issue.city_street %}
              <div>
                <span class="text-sm text-secondary font-semibold">Address:</span>
                <div>{{ issue.city_street }}</div>
              </div>
              {% endif %}
            </div>
          </div>
          {% if issue.location and issue.location.lat and issue.location.lng %}
          <div>
            <h4 class="font-semibold mb-3">Location</h4>
            <div id="map-{{ issue._id }}" style="height: 200px; border-radius: var(--radius-lg);"
              data-lat="{{ issue.location.lat }}" data-lng="{{ issue.location.lng }}"></div>

            <!-- Google Maps Link -->
            <div class="mt-4 space-y-2">
              <a href="https://www.google.com/maps/search/?api=1&query={{ issue.location.lat }},{{ issue.location.lng }}"
                target="_blank" class="google-maps-btn" onclick="trackMapClick('view_location', '{{ issue._id }}')">
                <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
                Open in Google Maps
              </a>

              <!-- Get Directions Link -->
              <a href="https://www.google.com/maps/dir/?api=1&destination={{ issue.location.lat }},{{ issue.location.lng }}"
                target="_blank" class="directions-btn" onclick="trackMapClick('get_directions', '{{ issue._id }}')">
                <i class="bi bi-compass" aria-hidden="true"></i>
                Get Directions
              </a>

              <!-- Coordinates Display -->
              <div class="coordinates-display">
                <i class="bi bi-geo" aria-hidden="true"></i>
                Coordinates: {{ "%.6f"|format(issue.location.lat) }}, {{ "%.6f"|format(issue.location.lng) }}
              </div>
            </div>
          </div>
          {% else %}
          <div>
            <h4 class="font-semibold mb-3">Location</h4>
            <div class="no-location-display">
              <div class="text-center">
                <i class="bi bi-geo-alt text-4xl mb-2 opacity-50" aria-hidden="true"></i>
                <p>No location coordinates available</p>
                {% if issue.city_street %}
                <p class="text-sm mt-2">Address: {{ issue.city_street }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('task-modal-{{ issue._id }}')">
          Close
        </button>
        {% if issue.location and issue.location.lat and issue.location.lng %}
        <a href="https://www.google.com/maps/search/?api=1&query={{ issue.location.lat }},{{ issue.location.lng }}"
          target="_blank" class="btn btn-primary inline-flex items-center gap-2"
          style="text-decoration: none; color: white;" onclick="trackMapClick('quick_view', '{{ issue._id }}')">
          <i class="bi bi-map" aria-hidden="true"></i>
          View on Map
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Completion Modal -->
  <div id="completion-modal-{{ issue._id }}" class="modal-backdrop"
    onclick="closeModal('completion-modal-{{ issue._id }}')">
    <div class="modal" onclick="event.stopPropagation()">
      <form action="{{ url_for('reports.maintenance_complete_issue', issue_id=issue._id) }}" method="POST"
        enctype="multipart/form-data">
        <div class="modal-header">
          <h3 class="modal-title">Mark Task Complete</h3>
          <button type="button" class="btn-close" onclick="closeModal('completion-modal-{{ issue._id }}')">
            <i class="bi bi-x-lg" aria-hidden="true"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-4">
            <label class="form-label">Work Description</label>
            <textarea name="completion_description" class="form-control" rows="4"
              placeholder="Describe the work completed..." required></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label class="form-label">Before Photo</label>
              <input type="file" name="before_image" accept="image/*" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">After Photo</label>
              <input type="file" name="after_image" accept="image/*" class="form-control" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('completion-modal-{{ issue._id }}')">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle" aria-hidden="true"></i>
            Submit Report
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}

  <!-- Image Modal -->
  <div id="image-modal" class="modal-backdrop" onclick="closeImageModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 80vw;">
      <div class="modal-header">
        <h3 class="modal-title">Issue Image</h3>
        <button class="btn-close" onclick="closeImageModal()">
          <i class="bi bi-x-lg" aria-hidden="true"></i>
        </button>
      </div>
      <div class="modal-body text-center">
        <img id="modal-image" src="" alt="Issue image"
          style="max-width: 100%; height: auto; border-radius: var(--radius-xl);">
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const maps = {};

    // Modal functions
    function showTaskModal(taskId) {
      const modal = document.getElementById(`task-modal-${taskId}`);
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';

      // Initialize map if it exists
      setTimeout(() => {
        const mapEl = document.getElementById(`map-${taskId}`);
        if (mapEl && !maps[taskId]) {
          const lat = parseFloat(mapEl.dataset.lat);
          const lng = parseFloat(mapEl.dataset.lng);
          if (!isNaN(lat) && !isNaN(lng)) {
            const map = L.map(`map-${taskId}`).setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            L.marker([lat, lng]).addTo(map);
            maps[taskId] = map;
          }
        }
      }, 300);
    }

    function showCompletionModal(taskId) {
      const modal = document.getElementById(`completion-modal-${taskId}`);
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');
      document.body.style.overflow = 'auto';
    }

    function showImageModal(src) {
      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');

      modalImage.src = src;
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
      const modal = document.getElementById('image-modal');
      modal.classList.remove('show');
      document.body.style.overflow = 'auto';

      setTimeout(() => {
        document.getElementById('modal-image').src = '';
      }, 300);
    }

    // Handle escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-backdrop.show').forEach(modal => {
          modal.classList.remove('show');
        });
        closeImageModal();
        document.body.style.overflow = 'auto';
      }
    });

    // Animation on scroll
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }
      });
    }, observerOptions);

    // Observe task cards
    document.querySelectorAll('.task-card').forEach((el, index) => {
      el.style.opacity = '0';
      el.style.transform = 'translateY(20px)';
      el.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
      observer.observe(el);
    });

    // Form submission handling
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('submit', function (e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = true;
          const originalContent = submitBtn.innerHTML;
          submitBtn.innerHTML = '<i class="bi bi-hourglass-split" aria-hidden="true"></i> Processing...';

          setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalContent;
          }, 3000);
        }
      });
    });

    // Track Google Maps clicks for analytics
    function trackMapClick(action, issueId) {
      console.log(`Map ${action} clicked for issue: ${issueId}`);

      // Optional: Send analytics data
      if (typeof gtag !== 'undefined') {
        gtag('event', 'map_interaction', {
          'event_category': 'maintenance_dashboard',
          'event_label': action,
          'value': issueId
        });
      }

      // Show feedback toast
      showLocationToast(action);
    }

    // Show feedback when location links are clicked
    function showLocationToast(action) {
      const messages = {
        'view_location': 'Opening location in Google Maps...',
        'get_directions': 'Getting directions in Google Maps...',
        'quick_view': 'Opening map view...'
      };

      const message = messages[action] || 'Opening map...';

      // Create toast notification
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.innerHTML = `
        <div class="toast-content">
          <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
          <span>${message}</span>
        </div>
      `;

      // Add toast styles
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4285f4, #34a853);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;

      document.body.appendChild(toast);

      // Animate in
      setTimeout(() => {
        toast.style.transform = 'translateX(0)';
      }, 100);

      // Remove after 3 seconds
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }
  </script>
</body>

</html>