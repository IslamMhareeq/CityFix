<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Users - CityFix</title>
  <meta name="description" content="Manage user accounts, roles, and permissions in CityFix.">

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard.css') }}">

  <style>
    .users-hero {
      background: linear-gradient(135deg, var(--primary-500), var(--emerald-500));
      color: white;
      padding: var(--space-12) 0;
      position: relative;
      overflow: hidden;
    }

    .users-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="users-pattern" width="30" height="30" patternUnits="userSpaceOnUse"><circle cx="15" cy="15" r="2" fill="white" opacity="0.1"/><circle cx="5" cy="5" r="1" fill="white" opacity="0.05"/><circle cx="25" cy="25" r="1.5" fill="white" opacity="0.08"/></pattern></defs><rect width="100" height="100" fill="url(%23users-pattern)"/></svg>');
    }

    .users-content {
      position: relative;
      z-index: 1;
      text-align: center;
    }

    .users-title {
      font-size: var(--text-4xl);
      font-weight: 800;
      margin-bottom: var(--space-4);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .users-subtitle {
      font-size: var(--text-xl);
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto var(--space-8);
    }

    .search-section {
      max-width: 500px;
      margin: 0 auto;
    }

    .search-box {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: var(--space-4) var(--space-6) var(--space-4) var(--space-12);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-full);
      font-size: var(--text-lg);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transition: var(--transition-all);
      backdrop-filter: blur(10px);
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .search-input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1);
    }

    .search-icon {
      position: absolute;
      left: var(--space-4);
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.7);
      font-size: var(--text-lg);
      pointer-events: none;
    }

    .users-container {
      max-width: 1200px;
      margin: calc(-1 * var(--space-8)) auto var(--space-16);
      position: relative;
      z-index: 2;
    }

    .users-card {
      background: white;
      border-radius: var(--radius-3xl);
      box-shadow: var(--shadow-2xl);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .users-header {
      padding: var(--space-8) var(--space-8) var(--space-6);
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .users-header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: var(--space-4);
    }

    .users-header-title {
      font-size: var(--text-2xl);
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .users-header-title i {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-100);
      color: var(--primary-600);
      border-radius: var(--radius-xl);
      font-size: var(--text-lg);
    }

    .users-stats {
      display: flex;
      gap: var(--space-6);
      flex-wrap: wrap;
    }

    .users-stat {
      text-align: center;
    }

    .users-stat-number {
      font-size: var(--text-2xl);
      font-weight: 800;
      color: var(--primary-600);
      line-height: 1;
      margin-bottom: var(--space-1);
    }

    .users-stat-label {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .users-table-container {
      overflow-x: auto;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table thead {
      background: var(--gray-50);
    }

    .users-table th {
      padding: var(--space-5) var(--space-6);
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      font-size: var(--text-sm);
      border-bottom: 1px solid var(--gray-200);
    }

    .users-table td {
      padding: var(--space-5) var(--space-6);
      border-bottom: 1px solid var(--gray-200);
      vertical-align: middle;
    }

    .users-table tbody tr {
      transition: var(--transition-colors);
    }

    .users-table tbody tr:hover {
      background: var(--primary-50);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-500), var(--emerald-500));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--text-lg);
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }

    .user-details {
      min-width: 0;
      flex: 1;
    }

    .user-name {
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-1);
      font-size: var(--text-base);
    }

    .user-email {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      word-break: break-all;
    }

    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .role-user {
      background: var(--blue-100);
      color: var(--blue-800);
    }

    .role-admin {
      background: var(--red-100);
      color: var(--red-800);
    }

    .role-maintenance {
      background: var(--emerald-100);
      color: var(--emerald-800);
    }

    .edit-form {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .edit-select {
      padding: var(--space-2) var(--space-3);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      background: white;
      color: var(--text-primary);
      min-width: 120px;
      transition: var(--transition-all);
    }

    .edit-select:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px var(--primary-100);
    }

    .edit-input {
      padding: var(--space-2) var(--space-3);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      background: white;
      color: var(--text-primary);
      min-width: 140px;
      transition: var(--transition-all);
    }

    .edit-input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px var(--primary-100);
    }

    .edit-btn {
      padding: var(--space-2) var(--space-4);
      background: var(--primary-500);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-all);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      white-space: nowrap;
    }

    .edit-btn:hover {
      background: var(--primary-600);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .delete-btn {
      padding: var(--space-2);
      background: var(--red-500);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: var(--transition-all);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }

    .delete-btn:hover {
      background: var(--red-600);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .actions-cell {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      min-width: 300px;
    }

    .action-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
    }

    .action-label {
      font-size: var(--text-xs);
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      min-width: 60px;
    }

    .empty-state {
      text-align: center;
      padding: var(--space-16) var(--space-6);
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: var(--text-6xl);
      margin-bottom: var(--space-6);
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: var(--text-xl);
      font-weight: 600;
      margin-bottom: var(--space-2);
      color: var(--text-secondary);
    }

    .empty-state p {
      color: var(--text-muted);
      margin-bottom: 0;
    }

    .users-footer {
      padding: var(--space-6) var(--space-8);
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
      text-align: center;
    }

    .users-count {
      color: var(--text-secondary);
      font-size: var(--text-sm);
      font-weight: 600;
    }

    .users-count strong {
      color: var(--text-primary);
    }

    .toast {
      position: fixed;
      top: var(--space-6);
      right: var(--space-6);
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2xl);
      border: 1px solid var(--gray-200);
      padding: var(--space-4) var(--space-6);
      z-index: 1000;
      transform: translateX(400px);
      opacity: 0;
      transition: var(--transition-all);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      max-width: 350px;
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast-success {
      border-left: 4px solid var(--emerald-500);
    }

    .toast-error {
      border-left: 4px solid var(--red-500);
    }

    .toast-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-sm);
      flex-shrink: 0;
    }

    .toast-success .toast-icon {
      background: var(--emerald-100);
      color: var(--emerald-600);
    }

    .toast-error .toast-icon {
      background: var(--red-100);
      color: var(--red-600);
    }

    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-1);
      font-size: var(--text-sm);
    }

    .toast-message {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    @media (max-width: 1024px) {
      .actions-cell {
        min-width: 250px;
      }

      .edit-form {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-2);
      }

      .edit-select,
      .edit-input {
        min-width: auto;
      }
    }

    @media (max-width: 768px) {
      .users-hero {
        padding: var(--space-8) 0;
      }

      .users-title {
        font-size: var(--text-2xl);
      }

      .users-subtitle {
        font-size: var(--text-base);
      }

      .users-container {
        margin: calc(-1 * var(--space-6)) var(--space-4) var(--space-12);
      }

      .users-header {
        padding: var(--space-6);
      }

      .users-header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .users-stats {
        width: 100%;
        justify-content: space-around;
      }

      .users-table th,
      .users-table td {
        padding: var(--space-4);
      }

      .user-info {
        gap: var(--space-3);
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        font-size: var(--text-base);
      }

      .actions-cell {
        min-width: 200px;
      }

      .action-row {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-2);
      }

      .action-label {
        min-width: auto;
        text-align: left;
      }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="navbar-content">
        <a href="{{ url_for('main.home') }}" class="navbar-brand">
          <img src="{{ url_for('static', filename='images/cityfixlogo.png') }}" alt="CityFix Logo" width="32"
            height="32" class="rounded-lg">
          <span>CityFix</span>
        </a>

        <ul class="navbar-nav">
          <li class="nav-item">
            <a href="{{ url_for('auth.dashboard') }}" class="nav-link">
              <i class="bi bi-speedometer2" aria-hidden="true"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('reports.report_issue') }}" class="nav-link">
              <i class="bi bi-plus-circle" aria-hidden="true"></i>
              <span>Report Issue</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('done_reports.done_issue') }}" class="nav-link">
              <i class="bi bi-check2-all" aria-hidden="true"></i>
              <span>Done Reports</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('main.profile') }}" class="nav-link">
              <i class="bi bi-person-circle" aria-hidden="true"></i>
              <span>Profile</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-primary">
              <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Users Hero -->
  <section class="users-hero">
    <div class="container">
      <div class="users-content">
        <h1 class="users-title">User Management</h1>
        <p class="users-subtitle">
          Manage user accounts, roles, and permissions.
          Keep your CityFix community organized and secure.
        </p>

        <div class="search-section">
          <div class="search-box">
            <i class="bi bi-search search-icon" aria-hidden="true"></i>
            <input type="text" id="search-input" class="search-input" placeholder="Search users by name or email..."
              onkeyup="filterUsers()">
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Users Container -->
  <main class="container">
    <div class="users-container">
      <div class="users-card">
        <!-- Users Header -->
        <div class="users-header">
          <div class="users-header-content">
            <h2 class="users-header-title">
              <i class="bi bi-people-fill" aria-hidden="true"></i>
              All Users
            </h2>

            <div class="users-stats">
              <div class="users-stat">
                <div class="users-stat-number">{{ users|selectattr('role', 'equalto', 'user')|list|length }}</div>
                <div class="users-stat-label">Citizens</div>
              </div>
              <div class="users-stat">
                <div class="users-stat-number">{{ users|selectattr('role', 'equalto', 'maintenance')|list|length }}
                </div>
                <div class="users-stat-label">Maintenance</div>
              </div>
              <div class="users-stat">
                <div class="users-stat-number">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</div>
                <div class="users-stat-label">Admins</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="users-table-container">
          {% if users %}
          <table class="users-table" id="users-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Current Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>
                  <div class="user-info">
                    <div class="user-avatar">
                      {{ user.name[0]|upper if user.name else user.email[0]|upper }}
                    </div>
                    <div class="user-details">
                      <div class="user-name">{{ user.name or 'No Name' }}</div>
                      <div class="user-email">{{ user.email }}</div>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="role-badge role-{{ user.role }}">
                    <i class="bi bi-{{ 'person' if user.role == 'user' else 'shield-check' if user.role == 'admin' else 'tools' }}"
                      aria-hidden="true"></i>
                    {{ user.role|title }}
                  </span>
                </td>
                <td>
                  <div class="actions-cell">
                    <!-- Role Update -->
                    <div class="action-row">
                      <span class="action-label">Role</span>
                      <form method="POST" action="{{ url_for('user_roles.edit_user_roles') }}" class="edit-form">
                        <input type="hidden" name="user_id" value="{{ user._id }}">
                        <select name="role" class="edit-select">
                          <option value="">Unchanged</option>
                          <option value="user" {{ 'selected' if user.role=='user' }}>Citizen</option>
                          <option value="maintenance" {{ 'selected' if user.role=='maintenance' }}>Maintenance</option>
                          <option value="admin" {{ 'selected' if user.role=='admin' }}>Admin</option>
                        </select>
                        <button type="submit" class="edit-btn">
                          <i class="bi bi-check" aria-hidden="true"></i>
                          Update
                        </button>
                      </form>
                    </div>

                    <!-- Password Update -->
                    <div class="action-row">
                      <span class="action-label">Password</span>
                      <form method="POST" action="{{ url_for('user_roles.edit_user_roles') }}" class="edit-form">
                        <input type="hidden" name="user_id" value="{{ user._id }}">
                        <input type="password" name="password" class="edit-input" placeholder="New password">
                        <button type="submit" class="edit-btn">
                          <i class="bi bi-key" aria-hidden="true"></i>
                          Reset
                        </button>
                      </form>
                    </div>

                    <!-- Delete User -->
                    <div class="action-row">
                      <span class="action-label">Delete</span>
                      <form method="POST" action="{{ url_for('user_roles.delete_user', user_id=user._id) }}"
                        onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.');"
                        style="margin-left: auto;">
                        <button type="submit" class="delete-btn" title="Delete User">
                          <i class="bi bi-trash" aria-hidden="true"></i>
                        </button>
                      </form>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="empty-state">
            <i class="bi bi-people" aria-hidden="true"></i>
            <h3>No Users Found</h3>
            <p>There are no user accounts to manage at this time.</p>
          </div>
          {% endif %}
        </div>

        <!-- Users Footer -->
        <div class="users-footer">
          <div class="users-count">
            Showing <strong>{{ users|length }}</strong> user{{ 's' if users|length != 1 else '' }}
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Notifications -->
  <div id="toast-container"></div>

  <script>
    // Search functionality
    function filterUsers() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const table = document.getElementById('users-table');

      if (!table) return;

      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      let visibleCount = 0;

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        const isVisible = text.includes(searchTerm);
        row.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
      }

      // Update footer count
      const footer = document.querySelector('.users-count');
      if (footer) {
        footer.innerHTML = `Showing <strong>${visibleCount}</strong> user${visibleCount !== 1 ? 's' : ''}`;
      }
    }

    // Toast notification system
    function showToast(type, title, message) {
      const toastContainer = document.getElementById('toast-container');

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
                <div class="toast-icon">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}" aria-hidden="true"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

      toastContainer.appendChild(toast);

      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 100);

      // Auto remove after 5 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Form submission handling
    document.addEventListener('DOMContentLoaded', function () {
      // Add loading states to forms
      document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function (e) {
          const submitBtn = this.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            const originalContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split" aria-hidden="true"></i>';

            // Re-enable after 3 seconds if form doesn't redirect
            setTimeout(() => {
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalContent;
            }, 3000);
          }
        });
      });

      // Show success message if needed
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('success') === 'true') {
        showToast('success', 'Success!', 'User has been updated successfully.');
      }

      // Enhanced form validation
      document.querySelectorAll('input[type="password"]').forEach(input => {
        input.addEventListener('input', function () {
          const submitBtn = this.closest('form').querySelector('button[type="submit"]');
          if (this.value.length > 0 && this.value.length < 6) {
            this.style.borderColor = 'var(--red-500)';
            submitBtn.disabled = true;
          } else {
            this.style.borderColor = 'var(--gray-300)';
            submitBtn.disabled = false;
          }
        });
      });

      // Role change confirmation
      document.querySelectorAll('select[name="role"]').forEach(select => {
        select.addEventListener('change', function () {
          if (this.value === 'admin') {
            if (!confirm('Are you sure you want to make this user an admin? This will give them full system access.')) {
              this.value = '';
            }
          }
        });
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
      // Ctrl/Cmd + F to focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('search-input').focus();
      }
    });

    // Auto-save search term in session storage
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', function () {
      sessionStorage.setItem('userSearchTerm', this.value);
    });

    // Restore search term on page load
    window.addEventListener('load', function () {
      const savedSearch = sessionStorage.getItem('userSearchTerm');
      if (savedSearch) {
        searchInput.value = savedSearch;
        filterUsers();
      }
    });

    // Add tooltips for better UX
    document.querySelectorAll('[title]').forEach(element => {
      element.addEventListener('mouseenter', function () {
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.textContent = this.getAttribute('title');
        // You can add tooltip positioning logic here
      });
    });
  </script>
</body>

</html>