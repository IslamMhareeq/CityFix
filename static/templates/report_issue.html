<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Issue - CityFix</title>
    <link rel="icon" href="{{ url_for('static', filename='images/web_icon.png') }}">
  <meta name="description" content="Report infrastructure issues in your city with detailed information and photos.">

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard.css') }}">

  <style>
    .report-hero {
      background: linear-gradient(135deg, var(--primary-500), var(--emerald-500));
      color: rgb(0, 0, 0);
      padding: var(--space-12) 0;
      position: relative;
      overflow: hidden;
    }

    .report-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
    }

    .report-content {
      position: relative;
      z-index: 1;
      text-align: center;
    }

    .report-title {
      font-size: var(--text-4xl);
      font-weight: 800;
      margin-bottom: var(--space-4);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .report-subtitle {
      font-size: var(--text-xl);
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto var(--space-8);
    }

    .progress-steps {
      display: flex;
      justify-content: center;
      gap: var(--space-4);
      flex-wrap: wrap;
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background: rgba(255, 255, 255, 0.2);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      font-weight: 600;
    }

    .progress-step.active {
      background: white;
      color: var(--primary-600);
    }

    .progress-step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: currentColor;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: 700;
    }

    .progress-step.active .progress-step-number {
      background: var(--primary-600);
    }

    .form-container {
      max-width: 800px;
      margin: calc(-1 * var(--space-12)) auto var(--space-16);
      position: relative;
      z-index: 2;
    }

    .form-card {
      background: white;
      border-radius: var(--radius-3xl);
      box-shadow: var(--shadow-2xl);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .form-step {
      display: none;
      padding: var(--space-8);
    }

    .form-step.active {
      display: block;
    }

    .step-header {
      text-align: center;
      margin-bottom: var(--space-8);
    }

    .step-title {
      font-size: var(--text-2xl);
      font-weight: 700;
      margin-bottom: var(--space-2);
      color: var(--text-primary);
    }

    .step-description {
      color: var(--text-secondary);
      font-size: var(--text-base);
    }

    .form-group {
      margin-bottom: var(--space-6);
    }

    .form-label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: 600;
      color: var(--text-primary);
      font-size: var(--text-sm);
    }

    .form-control {
      width: 100%;
      padding: var(--space-4);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-xl);
      font-size: var(--text-base);
      transition: var(--transition-all);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 4px var(--primary-100);
    }

    .form-select {
      width: 100%;
      padding: var(--space-4);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-xl);
      font-size: var(--text-base);
      transition: var(--transition-all);
      background: var(--bg-primary);
      color: var(--text-primary);
      cursor: pointer;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 4px var(--primary-100);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 120px;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
    }

    .category-option {
      position: relative;
    }

    .category-radio {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .category-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-6) var(--space-4);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-xl);
      cursor: pointer;
      transition: var(--transition-all);
      text-align: center;
      background: var(--bg-primary);
    }

    .category-card:hover {
      border-color: var(--primary-400);
      background: var(--primary-50);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .category-radio:checked+.category-card {
      border-color: var(--primary-500);
      background: var(--primary-100);
      box-shadow: var(--shadow-lg);
    }

    .category-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      background: var(--gray-100);
      color: var(--text-secondary);
      transition: var(--transition-all);
    }

    .category-radio:checked+.category-card .category-icon {
      background: var(--primary-500);
      color: white;
    }

    .category-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: var(--text-sm);
    }

    .map-container {
      height: 400px;
      border-radius: var(--radius-2xl);
      overflow: hidden;
      border: 2px solid var(--gray-300);
      margin-bottom: var(--space-4);
      position: relative;
    }

    .map-overlay {
      position: absolute;
      top: var(--space-4);
      left: var(--space-4);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      z-index: 1000;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
    }

    .file-upload-area {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      text-align: center;
      transition: var(--transition-all);
      cursor: pointer;
      background: var(--gray-50);
    }

    .file-upload-area:hover {
      border-color: var(--primary-400);
      background: var(--primary-50);
    }

    .file-upload-area.dragover {
      border-color: var(--primary-500);
      background: var(--primary-100);
    }

    .file-upload-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--primary-100);
      color: var(--primary-600);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-4);
      font-size: var(--text-2xl);
    }

    .file-upload-text {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }

    .file-upload-hint {
      color: var(--text-muted);
      font-size: var(--text-sm);
    }

    .file-preview {
      display: none;
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--emerald-50);
      border: 1px solid var(--emerald-200);
      border-radius: var(--radius-lg);
    }

    .file-preview.show {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .file-preview-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-lg);
      background: var(--emerald-500);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .file-preview-info {
      flex: 1;
      min-width: 0;
    }

    .file-preview-name {
      font-weight: 600;
      color: var(--emerald-800);
      margin-bottom: var(--space-1);
      word-break: break-all;
    }

    .file-preview-size {
      font-size: var(--text-xs);
      color: var(--emerald-600);
    }

    .btn-remove-file {
      background: none;
      border: none;
      color: var(--red-500);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-md);
      transition: var(--transition-colors);
    }

    .btn-remove-file:hover {
      background: var(--red-100);
      color: var(--red-600);
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
      margin-top: var(--space-8);
      padding-top: var(--space-6);
      border-top: 1px solid var(--gray-200);
    }

    .btn-step {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-xl);
      font-weight: 600;
      font-size: var(--text-base);
      cursor: pointer;
      transition: var(--transition-all);
      text-decoration: none;
    }

    .btn-step:hover {
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--gray-200);
      color: var(--text-secondary);
      border: 2px solid var(--gray-300);
    }

    .btn-secondary:hover {
      background: var(--gray-300);
      color: var(--text-primary);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      color: white;
      border: 2px solid var(--primary-500);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      color: white;
    }

    .btn-primary:disabled {
      background: var(--gray-300);
      color: var(--text-muted);
      border-color: var(--gray-300);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .location-info {
      background: var(--blue-50);
      border: 1px solid var(--blue-200);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-top: var(--space-4);
    }

    .location-info-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
      color: var(--blue-800);
      font-weight: 600;
    }

    .location-coordinates {
      font-size: var(--text-sm);
      color: var(--blue-600);
      font-family: 'Monaco', 'Menlo', monospace;
    }

    .summary-card {
      background: var(--gray-50);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--gray-200);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .summary-value {
      color: var(--text-primary);
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .form-container {
        margin: calc(-1 * var(--space-8)) var(--space-4) var(--space-12);
      }

      .form-step {
        padding: var(--space-6);
      }

      .category-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .progress-steps {
        gap: var(--space-2);
      }

      .progress-step {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-xs);
      }

      .progress-step-text {
        display: none;
      }

      .form-actions {
        flex-direction: column;
        gap: var(--space-3);
      }

      .btn-step {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="navbar-content">
        <a href="{{ url_for('main.home') }}" class="navbar-brand">
          <img src="{{ url_for('static', filename='images/cityfixlogo.png') }}" alt="CityFix Logo" width="32"
            height="32" class="rounded-lg">
          <span>CityFix</span>
        </a>

        <ul class="navbar-nav">
          <li class="nav-item">
            <a href="{{ url_for('auth.dashboard') }}" class="nav-link">
              <i class="bi bi-speedometer2" aria-hidden="true"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('reports.my_reports') }}" class="nav-link">
              <i class="bi bi-journal-text" aria-hidden="true"></i>
              <span>My Reports</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('main.profile') }}" class="nav-link">
              <i class="bi bi-person-circle" aria-hidden="true"></i>
              <span>Profile</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-primary">
              <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Report Hero -->
  <section class="report-hero">
    <div class="container">
      <div class="report-content">
        <h1 class="report-title">Report an Issue</h1>
        <p class="report-subtitle">
          Help improve your city by reporting infrastructure problems.
          Your reports help make communities safer and better maintained.
        </p>

        <div class="progress-steps">
          <div class="progress-step active" id="step-indicator-1">
            <span class="progress-step-number">1</span>
            <span class="progress-step-text">Details</span>
          </div>
          <div class="progress-step" id="step-indicator-2">
            <span class="progress-step-number">2</span>
            <span class="progress-step-text">Category</span>
          </div>
          <div class="progress-step" id="step-indicator-3">
            <span class="progress-step-number">3</span>
            <span class="progress-step-text">Location</span>
          </div>
          <div class="progress-step" id="step-indicator-4">
            <span class="progress-step-number">4</span>
            <span class="progress-step-text">Photo</span>
          </div>
          <div class="progress-step" id="step-indicator-5">
            <span class="progress-step-number">5</span>
            <span class="progress-step-text">Review</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Form Container -->
  <main class="container">
    <div class="form-container">
      <form class="form-card" action="{{ url_for('reports.report_issue') }}" method="POST" enctype="multipart/form-data"
        id="reportForm">
        <!-- Step 1: Details -->
        <div class="form-step active" id="step-1">
          <div class="step-header">
            <h2 class="step-title">Describe the Issue</h2>
            <p class="step-description">
              Provide a clear and detailed description of the problem you're reporting.
            </p>
          </div>

          <div class="form-group">
            <label for="description" class="form-label">
              <i class="bi bi-chat-left-text me-2" aria-hidden="true"></i>
              Problem Description
            </label>
            <textarea id="description" name="description" class="form-control"
              placeholder="Describe the issue in detail. What exactly is the problem? How does it affect the area?"
              required></textarea>
          </div>

          <div class="form-group">
            <label for="city_street" class="form-label">
              <i class="bi bi-geo-alt me-2" aria-hidden="true"></i>
              Street Address or Location
            </label>
            <input type="text" id="city_street" name="city_street" class="form-control"
              placeholder="e.g., 123 Main Street, Downtown, or near Central Park" required>
          </div>

          <div class="form-actions">
            <div></div>
            <button type="button" class="btn-step btn-primary" onclick="nextStep()">
              Next: Choose Category
              <i class="bi bi-arrow-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Category -->
        <div class="form-step" id="step-2">
          <div class="step-header">
            <h2 class="step-title">Select Issue Category</h2>
            <p class="step-description">
              Choose the category that best describes your issue.
            </p>
          </div>

          <div class="category-grid">
            <div class="category-option">
              <input type="radio" id="cat-traffic" name="category" value="traffic_light_failure" class="category-radio">
              <label for="cat-traffic" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-traffic-light" aria-hidden="true"></i>
                </div>
                <span class="category-name">Traffic Light</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-water" name="category" value="water_leak" class="category-radio">
              <label for="cat-water" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-droplet" aria-hidden="true"></i>
                </div>
                <span class="category-name">Water Leak</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-road" name="category" value="road_closure" class="category-radio">
              <label for="cat-road" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-sign-stop" aria-hidden="true"></i>
                </div>
                <span class="category-name">Road Closure</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-power" name="category" value="power_cut" class="category-radio">
              <label for="cat-power" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-lightning" aria-hidden="true"></i>
                </div>
                <span class="category-name">Power Outage</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-pothole" name="category" value="pothole" class="category-radio">
              <label for="cat-pothole" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-cone-striped" aria-hidden="true"></i>
                </div>
                <span class="category-name">Pothole</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-lighting" name="category" value="street_lighting" class="category-radio">
              <label for="cat-lighting" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-lightbulb" aria-hidden="true"></i>
                </div>
                <span class="category-name">Street Lighting</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-signage" name="category" value="missing_signage" class="category-radio">
              <label for="cat-signage" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-signpost" aria-hidden="true"></i>
                </div>
                <span class="category-name">Missing Signs</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-other" name="category" value="other" class="category-radio">
              <label for="cat-other" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-three-dots" aria-hidden="true"></i>
                </div>
                <span class="category-name">Other</span>
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-step btn-secondary" onclick="prevStep()">
              <i class="bi bi-arrow-left" aria-hidden="true"></i>
              Back
            </button>
            <button type="button" class="btn-step btn-primary" onclick="nextStep()" id="step2-next" disabled>
              Next: Set Location
              <i class="bi bi-arrow-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Location -->
        <div class="form-step" id="step-3">
          <div class="step-header">
            <h2 class="step-title">Pin the Location</h2>
            <p class="step-description">
              Click on the map to pinpoint the exact location of the issue.
            </p>
          </div>

          <div class="map-container">
            <div class="map-overlay">
              <i class="bi bi-crosshair me-2" aria-hidden="true"></i>
              Click on the map to set location
            </div>
            <div id="map" style="height: 100%; width: 100%;"></div>
          </div>

          <div id="location-info" class="location-info" style="display: none;">
            <div class="location-info-header">
              <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
              Selected Location
            </div>
            <div class="location-coordinates" id="coordinates-display">
              Coordinates will appear here
            </div>
          </div>

          <input type="hidden" id="lat" name="lat">
          <input type="hidden" id="lng" name="lng">

          <div class="form-actions">
            <button type="button" class="btn-step btn-secondary" onclick="prevStep()">
              <i class="bi bi-arrow-left" aria-hidden="true"></i>
              Back
            </button>
            <button type="button" class="btn-step btn-primary" onclick="nextStep()" id="step3-next" disabled>
              Next: Add Photo
              <i class="bi bi-arrow-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Step 4: Photo -->
        <div class="form-step" id="step-4">
          <div class="step-header">
            <h2 class="step-title">Add a Photo</h2>
            <p class="step-description">
              Upload a photo to help illustrate the issue (optional but recommended).
            </p>
          </div>

          <div class="file-upload-area" id="file-upload-area">
            <div class="file-upload-icon">
              <i class="bi bi-camera" aria-hidden="true"></i>
            </div>
            <div class="file-upload-text">
              Drag and drop your photo here
            </div>
            <div class="file-upload-hint">
              or click to browse (JPG, PNG, GIF up to 10MB)
            </div>
            <input type="file" id="image" name="image" accept="image/*" style="display: none;">
          </div>

          <div class="file-preview" id="file-preview">
            <div class="file-preview-icon">
              <i class="bi bi-image" aria-hidden="true"></i>
            </div>
            <div class="file-preview-info">
              <div class="file-preview-name" id="file-name"></div>
              <div class="file-preview-size" id="file-size"></div>
            </div>
            <button type="button" class="btn-remove-file" onclick="removeFile()">
              <i class="bi bi-x-lg" aria-hidden="true"></i>
            </button>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-step btn-secondary" onclick="prevStep()">
              <i class="bi bi-arrow-left" aria-hidden="true"></i>
              Back
            </button>
            <button type="button" class="btn-step btn-primary" onclick="nextStep()">
              Next: Review & Submit
              <i class="bi bi-arrow-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Step 5: Review -->
        <div class="form-step" id="step-5">
          <div class="step-header">
            <h2 class="step-title">Review Your Report</h2>
            <p class="step-description">
              Please review all information before submitting your report.
            </p>
          </div>

          <div class="summary-card">
            <div class="summary-item">
              <span class="summary-label">Description</span>
              <span class="summary-value" id="review-description">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Category</span>
              <span class="summary-value" id="review-category">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Location</span>
              <span class="summary-value" id="review-location">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Photo</span>
              <span class="summary-value" id="review-photo">-</span>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-step btn-secondary" onclick="prevStep()">
              <i class="bi bi-arrow-left" aria-hidden="true"></i>
              Back
            </button>
            <button type="submit" class="btn-step btn-primary">
              <i class="bi bi-send" aria-hidden="true"></i>
              Submit Report
            </button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let currentStep = 1;
    const totalSteps = 5;
    let map;
    let marker;

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function () {
      initializeMap();
      initializeFileUpload();
      setupCategorySelection();
      setupFormValidation();
    });

    // Step navigation
    function nextStep() {
      if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
          showStep(currentStep + 1);
        }
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }

    function showStep(step) {
      // Hide current step
      document.getElementById(`step-${currentStep}`).classList.remove('active');
      document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');

      // Show new step
      currentStep = step;
      document.getElementById(`step-${currentStep}`).classList.add('active');
      document.getElementById(`step-indicator-${currentStep}`).classList.add('active');

      // Special handling for map step
      if (currentStep === 3 && map) {
        setTimeout(() => map.invalidateSize(), 100);
      }

      // Update review step
      if (currentStep === 5) {
        updateReviewStep();
      }
    }

    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          const description = document.getElementById('description').value.trim();
          const cityStreet = document.getElementById('city_street').value.trim();
          if (!description || !cityStreet) {
            alert('Please fill in all required fields.');
            return false;
          }
          return true;

        case 2:
          const selectedCategory = document.querySelector('input[name="category"]:checked');
          if (!selectedCategory) {
            alert('Please select a category.');
            return false;
          }
          return true;

        case 3:
          const lat = document.getElementById('lat').value;
          const lng = document.getElementById('lng').value;
          if (!lat || !lng) {
            alert('Please select a location on the map.');
            return false;
          }
          return true;

        default:
          return true;
      }
    }

    // Map functionality
    function initializeMap() {
      map = L.map('map').setView([31.7683, 35.2137], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      map.on('click', function (e) {
        setLocation(e.latlng.lat, e.latlng.lng);
      });

      // Try to get user's location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          map.setView([lat, lng], 15);
        }, function () {
          // Use default location if geolocation fails
        });
      }
    }

    function setLocation(lat, lng) {
      if (marker) {
        map.removeLayer(marker);
      }

      marker = L.marker([lat, lng], { draggable: true }).addTo(map);

      marker.on('dragend', function (e) {
        const pos = e.target.getLatLng();
        setLocation(pos.lat, pos.lng);
      });

      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lng').value = lng.toFixed(6);

      // Show location info
      const locationInfo = document.getElementById('location-info');
      const coordinatesDisplay = document.getElementById('coordinates-display');
      coordinatesDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      locationInfo.style.display = 'block';

      // Enable next button
      document.getElementById('step3-next').disabled = false;
    }

    // File upload functionality
    function initializeFileUpload() {
      const fileInput = document.getElementById('image');
      const uploadArea = document.getElementById('file-upload-area');
      const filePreview = document.getElementById('file-preview');

      uploadArea.addEventListener('click', function () {
        fileInput.click();
      });

      uploadArea.addEventListener('dragover', function (e) {
        e.preventDefault();
        this.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      fileInput.addEventListener('change', function (e) {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    function handleFileSelect(file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }

      // Validate file size (10MB max)
      if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB.');
        return;
      }

      // Update file input
      const fileInput = document.getElementById('image');
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;

      // Show preview
      showFilePreview(file);
    }

    function showFilePreview(file) {
      const fileName = document.getElementById('file-name');
      const fileSize = document.getElementById('file-size');
      const filePreview = document.getElementById('file-preview');
      const uploadArea = document.getElementById('file-upload-area');

      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);

      filePreview.classList.add('show');
      uploadArea.style.display = 'none';
    }

    function removeFile() {
      const fileInput = document.getElementById('image');
      const filePreview = document.getElementById('file-preview');
      const uploadArea = document.getElementById('file-upload-area');

      fileInput.value = '';
      filePreview.classList.remove('show');
      uploadArea.style.display = 'block';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Category selection
    function setupCategorySelection() {
      const categoryRadios = document.querySelectorAll('input[name="category"]');
      const nextButton = document.getElementById('step2-next');

      categoryRadios.forEach(radio => {
        radio.addEventListener('change', function () {
          nextButton.disabled = false;
        });
      });
    }

    // Review step
    function updateReviewStep() {
      const description = document.getElementById('description').value;
      const category = document.querySelector('input[name="category"]:checked');
      const cityStreet = document.getElementById('city_street').value;
      const lat = document.getElementById('lat').value;
      const lng = document.getElementById('lng').value;
      const fileInput = document.getElementById('image');

      document.getElementById('review-description').textContent = description.substring(0, 100) + (description.length > 100 ? '...' : '');
      document.getElementById('review-category').textContent = category ? getCategoryName(category.value) : '-';
      document.getElementById('review-location').textContent = cityStreet;
      document.getElementById('review-photo').textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'No photo selected';
    }

    function getCategoryName(value) {
      const names = {
        'traffic_light_failure': 'Traffic Light',
        'water_leak': 'Water Leak',
        'road_closure': 'Road Closure',
        'power_cut': 'Power Outage',
        'pothole': 'Pothole',
        'street_lighting': 'Street Lighting',
        'missing_signage': 'Missing Signs',
        'other': 'Other'
      };
      return names[value] || value;
    }

    // Form validation
    function setupFormValidation() {
      const form = document.getElementById('reportForm');

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        // Final validation
        if (!validateCurrentStep()) {
          return;
        }

        // Show loading state
        const submitButton = document.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="bi bi-hourglass-split" aria-hidden="true"></i> Submitting...';
        submitButton.disabled = true;

        // Submit form
        setTimeout(() => {
          form.submit();
        }, 1000);
      });
    }

    // Address geocoding
    const addressInput = document.getElementById('city_street');
    let geocodeTimer;

    addressInput.addEventListener('input', function () {
      clearTimeout(geocodeTimer);
      geocodeTimer = setTimeout(() => {
        const query = this.value.trim();
        if (query.length > 5 && map) {
          geocodeAddress(query);
        }
      }, 1000);
    });

    function geocodeAddress(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=il&bounded=1&q=${encodeURIComponent(address)}`;

      fetch(url)
        .then(response => response.json())
        .then(results => {
          if (results.length > 0) {
            const result = results[0];
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);

            if (map) {
              map.setView([lat, lng], 16);
              setLocation(lat, lng);
            }
          }
        })
        .catch(error => {
          console.log('Geocoding error:', error);
        });
    }
  </script>
</body>

</html>