<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="{{ url_for('static', filename='images/web_icon.png') }}">
  <title>Report Issue - CityFix</title>
  <link rel="icon" href="{{ url_for('static', filename='images/web_icon.png') }}">
  <meta name="description" content="Report infrastructure issues in your city with detailed information and photos.">

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/pages/report_issue.css') }}">
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="navbar-content">
         <a href="{{ url_for('main.home') }}" class="navbar-brand-liquid"> <span class="liquid-text">CityFix</span> </a>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a href="{{ url_for('auth.dashboard') }}" class="nav-link">
              <i class="bi bi-speedometer2" aria-hidden="true"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('reports.my_reports') }}" class="nav-link">
              <i class="bi bi-journal-text" aria-hidden="true"></i>
              <span>My Reports</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('main.profile') }}" class="nav-link">
              <i class="bi bi-person-circle" aria-hidden="true"></i>
              <span>Profile</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-primary">
              <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Report Hero -->
  <section class="report-hero">
    <div class="container">
      <div class="report-content">
        <h1 class="report-title">Report an Issue</h1>
        <p class="report-subtitle">
          Help improve your city by reporting infrastructure problems.
          Your reports help make communities safer and better maintained.
        </p>

        <div class="progress-steps">
          <div class="progress-step active" id="step-indicator-1">
            <span class="progress-step-number">1</span>
            <span class="progress-step-text">Details</span>
          </div>
          <div class="progress-step" id="step-indicator-2">
            <span class="progress-step-number">2</span>
            <span class="progress-step-text">Category</span>
          </div>
          <div class="progress-step" id="step-indicator-3">
            <span class="progress-step-number">3</span>
            <span class="progress-step-text">Location</span>
          </div>
          <div class="progress-step" id="step-indicator-4">
            <span class="progress-step-number">4</span>
            <span class="progress-step-text">Photo</span>
          </div>
          <div class="progress-step" id="step-indicator-5">
            <span class="progress-step-number">5</span>
            <span class="progress-step-text">Review</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Form Container -->
  <main class="container">
    <div class="form-container">
      <form class="form-card" action="{{ url_for('reports.report_issue') }}" method="POST" enctype="multipart/form-data"
        id="reportForm">
        <!-- Step 1: Details -->
        <div class="form-step active" id="step-1">
          <div class="step-header">
            <h2 class="step-title">Describe the Issue</h2>
            <p class="step-description">
              Provide a clear and detailed description of the problem you're reporting.
            </p>
          </div>

          <div class="form-group">
            <label for="description" class="form-label">
              <i class="bi bi-chat-left-text me-2" aria-hidden="true"></i>
              Problem Description
            </label>
            <textarea id="description" name="description" class="form-control"
              placeholder="Describe the issue in detail. What exactly is the problem? How does it affect the area?"
              required></textarea>
          </div>



          <div class="form-actions">
            <div></div>
            <button type="button" class="btn-step btn-primary" onclick="nextStep()">
              Next: Choose Category
              <i class="bi bi-arrow-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Category -->
        <div class="form-step" id="step-2">
          <div class="step-header">
            <h2 class="step-title">Select Issue Category</h2>
            <p class="step-description">
              Choose the category that best describes your issue.
            </p>
          </div>

          <div class="category-grid">
            <div class="category-option">
              <input type="radio" id="cat-traffic" name="category" value="traffic_light_failure" class="category-radio">
              <label for="cat-traffic" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-traffic-light" aria-hidden="true"></i>
                </div>
                <span class="category-name">Traffic Light</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-water" name="category" value="water_leak" class="category-radio">
              <label for="cat-water" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-droplet" aria-hidden="true"></i>
                </div>
                <span class="category-name">Water Leak</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-road" name="category" value="road_closure" class="category-radio">
              <label for="cat-road" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-sign-stop" aria-hidden="true"></i>
                </div>
                <span class="category-name">Road Closure</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-power" name="category" value="power_cut" class="category-radio">
              <label for="cat-power" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-lightning" aria-hidden="true"></i>
                </div>
                <span class="category-name">Power Outage</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-pothole" name="category" value="pothole" class="category-radio">
              <label for="cat-pothole" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-cone-striped" aria-hidden="true"></i>
                </div>
                <span class="category-name">Pothole</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-lighting" name="category" value="street_lighting" class="category-radio">
              <label for="cat-lighting" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-lightbulb" aria-hidden="true"></i>
                </div>
                <span class="category-name">Street Lighting</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-signage" name="category" value="missing_signage" class="category-radio">
              <label for="cat-signage" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-signpost" aria-hidden="true"></i>
                </div>
                <span class="category-name">Missing Signs</span>
              </label>
            </div>

            <div class="category-option">
              <input type="radio" id="cat-other" name="category" value="other" class="category-radio">
              <label for="cat-other" class="category-card">
                <div class="category-icon">
                  <i class="bi bi-three-dots" aria-hidden="true"></i>
                </div>
                <span class="category-name">Other</span>
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-step btn-secondary" onclick="prevStep()">
              <i class="bi bi-arrow-left" aria-hidden="true"></i>
              Back
            </button>
            <button type="button" class="btn-step btn-primary" onclick="nextStep()" id="step2-next" disabled>
              Next: Set Location
              <i class="bi bi-arrow-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Location -->
        <div class="form-step" id="step-3">
          <div class="step-header">
            <h2 class="step-title">Set Location</h2>
            <p class="step-description">
              Choose how you want to set the location for this issue.
            </p>
          </div>

          <div class="location-controls">
            <button type="button" class="location-btn" onclick="getCurrentLocation()" id="auto-location-btn">
              <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
              Use Current Location
            </button>
            <button type="button" class="location-btn secondary" onclick="focusAddressInput()" id="address-btn">
              <i class="bi bi-search" aria-hidden="true"></i>
              Search Address
            </button>
          </div>

          <div class="form-group">
            <label for="city_street" class="form-label">
              <i class="bi bi-geo-alt me-2" aria-hidden="true"></i>
              Street Address or Location
              <span style="font-size: var(--text-xs); font-weight: normal; color: var(--text-muted);">(searches as you type)</span>
            </label>
            <div class="search-input-wrapper">
              <input type="text" id="city_street" name="city_street" class="form-control"
                placeholder="Start typing: Tel Aviv, Jerusalem, Haifa..." required>
              <div class="search-spinner" id="search-spinner" style="display: none;">
                <i class="bi bi-search" aria-hidden="true"></i>
              </div>
            </div>
          </div>

          <div id="location-status" class="location-status" style="display: none;">
            <div class="status-icon">
              <i class="bi bi-check" aria-hidden="true"></i>
            </div>
            <span>Location ready</span>
          </div>

          <div class="map-container">
            <div class="map-overlay">
              <i class="bi bi-crosshair me-2" aria-hidden="true"></i>
              Click on the map to set location
            </div>
            <div id="map" style="height: 100%; width: 100%;"></div>
          </div>

          <div id="location-info" class="location-info" style="display: none;">
            <div class="location-info-header">
              <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
              Selected Location
            </div>
            <div class="location-coordinates" id="coordinates-display">
              Coordinates will appear here
            </div>
            <div class="location-address" id="address-display"></div>
          </div>

          <div id="location-error" class="error-message">
            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
            <span id="error-text">Location error</span>
          </div>

          <input type="hidden" id="lat" name="lat">
          <input type="hidden" id="lng" name="lng">

          <div class="form-actions">
            <button type="button" class="btn-step btn-secondary" onclick="prevStep()">
              <i class="bi bi-arrow-left" aria-hidden="true"></i>
              Back
            </button>
            <button type="button" class="btn-step btn-primary" onclick="nextStep()" id="step3-next" disabled>
              Next: Add Photo
              <i class="bi bi-arrow-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Step 4: Photo -->
        <div class="form-step" id="step-4">
          <div class="step-header">
            <h2 class="step-title">Add a Photo</h2>
            <p class="step-description">
              Upload a photo to help illustrate the issue (optional but recommended).
            </p>
          </div>

          <div class="file-upload-area" id="file-upload-area">
            <div class="file-upload-icon">
              <i class="bi bi-camera" aria-hidden="true"></i>
            </div>
            <div class="file-upload-text">
              Drag and drop your photo here
            </div>
            <div class="file-upload-hint">
              or click to browse (JPG, PNG, GIF up to 10MB)
            </div>
            <input type="file" id="image" name="image" accept="image/*" style="display: none;">
          </div>

          <div class="file-preview" id="file-preview">
            <div class="file-preview-icon">
              <i class="bi bi-image" aria-hidden="true"></i>
            </div>
            <div class="file-preview-info">
              <div class="file-preview-name" id="file-name"></div>
              <div class="file-preview-size" id="file-size"></div>
            </div>
            <button type="button" class="btn-remove-file" onclick="removeFile()">
              <i class="bi bi-x-lg" aria-hidden="true"></i>
            </button>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-step btn-secondary" onclick="prevStep()">
              <i class="bi bi-arrow-left" aria-hidden="true"></i>
              Back
            </button>
            <button type="button" class="btn-step btn-primary" onclick="nextStep()">
              Next: Review & Submit
              <i class="bi bi-arrow-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Step 5: Review -->
        <div class="form-step" id="step-5">
          <div class="step-header">
            <h2 class="step-title">Review Your Report</h2>
            <p class="step-description">
              Please review all information before submitting your report.
            </p>
          </div>

          <div class="summary-card">
            <div class="summary-item">
              <span class="summary-label">Description</span>
              <span class="summary-value" id="review-description">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Category</span>
              <span class="summary-value" id="review-category">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Location</span>
              <span class="summary-value" id="review-location">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Photo</span>
              <span class="summary-value" id="review-photo">-</span>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-step btn-secondary" onclick="prevStep()">
              <i class="bi bi-arrow-left" aria-hidden="true"></i>
              Back
            </button>
            <button type="submit" class="btn-step btn-primary">
              <i class="bi bi-send" aria-hidden="true"></i>
              Submit Report
            </button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let currentStep = 1;
    const totalSteps = 5;
    let map;
    let marker;
    let locationSet = false;

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function () {
      initializeMap();
      initializeFileUpload();
      setupCategorySelection();
      setupFormValidation();
    });

    // Step navigation
    function nextStep() {
      if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
          showStep(currentStep + 1);
        }
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }

    function showStep(step) {
      // Hide current step
      document.getElementById(`step-${currentStep}`).classList.remove('active');
      document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');

      // Show new step
      currentStep = step;
      document.getElementById(`step-${currentStep}`).classList.add('active');
      document.getElementById(`step-indicator-${currentStep}`).classList.add('active');

      // Special handling for map step
      if (currentStep === 3 && map) {
        setTimeout(() => map.invalidateSize(), 100);
      }

      // Update review step
      if (currentStep === 5) {
        updateReviewStep();
      }
    }

    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          const description = document.getElementById('description').value.trim();
          if (!description) {
            showError('Please fill in the description field.');
            return false;
          }
          return true;

        case 2:
          const selectedCategory = document.querySelector('input[name="category"]:checked');
          if (!selectedCategory) {
            showError('Please select a category.');
            return false;
          }
          return true;

        case 3:
          const lat = document.getElementById('lat').value;
          const lng = document.getElementById('lng').value;
          const cityStreet = document.getElementById('city_street').value.trim();
          if (!lat || !lng) {
            showError('Please set a location on the map.');
            return false;
          }
          if (!cityStreet) {
            showError('Please enter a street address or location description.');
            return false;
          }
          return true;

        default:
          return true;
      }
    }

    // Map functionality
    function initializeMap() {
      map = L.map('map').setView([31.7683, 35.2137], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      map.on('click', function (e) {
        setLocation(e.latlng.lat, e.latlng.lng, 'manual');
      });
    }

    function getCurrentLocation() {
      const btn = document.getElementById('auto-location-btn');
      const originalText = btn.innerHTML;
      
      btn.innerHTML = '<i class="bi bi-hourglass-split" aria-hidden="true"></i> Getting location...';
      btn.disabled = true;

      if (!navigator.geolocation) {
        showLocationError('Geolocation is not supported by this browser.');
        resetLocationButton();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          setLocation(lat, lng, 'auto');
          map.setView([lat, lng], 16);
          resetLocationButton();
        },
        function (error) {
          let errorMessage = 'Unable to get your location.';
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'Location access denied. Please enable location permissions.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'Location information unavailable.';
              break;
            case error.TIMEOUT:
              errorMessage = 'Location request timed out.';
              break;
          }
          showLocationError(errorMessage);
          resetLocationButton();
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );

      function resetLocationButton() {
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 1000);
      }
    }

    function focusAddressInput() {
      const addressInput = document.getElementById('city_street');
      addressInput.focus();
      addressInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function setLocation(lat, lng, source) {
      if (marker) {
        map.removeLayer(marker);
      }

      marker = L.marker([lat, lng], { draggable: true }).addTo(map);

      marker.on('dragend', function (e) {
        const pos = e.target.getLatLng();
        setLocation(pos.lat, pos.lng, 'manual');
      });

      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lng').value = lng.toFixed(6);

      // Show location info
      showLocationInfo(lat, lng);
      
      // Enable next button
      document.getElementById('step3-next').disabled = false;
      locationSet = true;

      // Reverse geocode to get address
      reverseGeocode(lat, lng);

      // Hide error if shown
      hideLocationError();
    }

    function showLocationInfo(lat, lng) {
      const locationInfo = document.getElementById('location-info');
      const coordinatesDisplay = document.getElementById('coordinates-display');
      const statusDiv = document.getElementById('location-status');
      
      coordinatesDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      locationInfo.style.display = 'block';
      statusDiv.style.display = 'flex';
      
      // Update status
      const statusIcon = statusDiv.querySelector('.status-icon');
      statusIcon.className = 'status-icon status-success';
      statusIcon.innerHTML = '<i class="bi bi-check" aria-hidden="true"></i>';
      statusDiv.querySelector('span').textContent = 'Location set successfully';
    }

    function reverseGeocode(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.display_name) {
            const addressDisplay = document.getElementById('address-display');
            addressDisplay.textContent = data.display_name;
          }
        })
        .catch(error => {
          console.log('Reverse geocoding failed:', error);
        });
    }

    function showLocationError(message) {
      const errorDiv = document.getElementById('location-error');
      const errorText = document.getElementById('error-text');
      const statusDiv = document.getElementById('location-status');
      
      errorText.textContent = message;
      errorDiv.classList.add('show');
      
      // Update status
      statusDiv.style.display = 'flex';
      const statusIcon = statusDiv.querySelector('.status-icon');
      statusIcon.className = 'status-icon status-error';
      statusIcon.innerHTML = '<i class="bi bi-x" aria-hidden="true"></i>';
      statusDiv.querySelector('span').textContent = 'Location error';
    }

    function hideLocationError() {
      document.getElementById('location-error').classList.remove('show');
    }

    function showError(message) {
      alert(message); // You can replace this with a better error display
    }

    // File upload functionality
    function initializeFileUpload() {
      const fileInput = document.getElementById('image');
      const uploadArea = document.getElementById('file-upload-area');
      const filePreview = document.getElementById('file-preview');

      uploadArea.addEventListener('click', function () {
        fileInput.click();
      });

      uploadArea.addEventListener('dragover', function (e) {
        e.preventDefault();
        this.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      fileInput.addEventListener('change', function (e) {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    function handleFileSelect(file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showError('Please select an image file.');
        return;
      }

      // Validate file size (10MB max)
      if (file.size > 10 * 1024 * 1024) {
        showError('File size must be less than 10MB.');
        return;
      }

      // Update file input
      const fileInput = document.getElementById('image');
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;

      // Show preview
      showFilePreview(file);
    }

    function showFilePreview(file) {
      const fileName = document.getElementById('file-name');
      const fileSize = document.getElementById('file-size');
      const filePreview = document.getElementById('file-preview');
      const uploadArea = document.getElementById('file-upload-area');

      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);

      filePreview.classList.add('show');
      uploadArea.style.display = 'none';
    }

    function removeFile() {
      const fileInput = document.getElementById('image');
      const filePreview = document.getElementById('file-preview');
      const uploadArea = document.getElementById('file-upload-area');

      fileInput.value = '';
      filePreview.classList.remove('show');
      uploadArea.style.display = 'block';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Category selection
    function setupCategorySelection() {
      const categoryRadios = document.querySelectorAll('input[name="category"]');
      const nextButton = document.getElementById('step2-next');

      categoryRadios.forEach(radio => {
        radio.addEventListener('change', function () {
          nextButton.disabled = false;
        });
      });
    }

    // Review step
    function updateReviewStep() {
      const description = document.getElementById('description').value;
      const category = document.querySelector('input[name="category"]:checked');
      const cityStreet = document.getElementById('city_street').value;
      const lat = document.getElementById('lat').value;
      const lng = document.getElementById('lng').value;
      const fileInput = document.getElementById('image');

      document.getElementById('review-description').textContent = description.substring(0, 100) + (description.length > 100 ? '...' : '');
      document.getElementById('review-category').textContent = category ? getCategoryName(category.value) : '-';
      document.getElementById('review-location').textContent = cityStreet;
      document.getElementById('review-photo').textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'No photo selected';
    }

    function getCategoryName(value) {
      const names = {
        'traffic_light_failure': 'Traffic Light',
        'water_leak': 'Water Leak',
        'road_closure': 'Road Closure',
        'power_cut': 'Power Outage',
        'pothole': 'Pothole',
        'street_lighting': 'Street Lighting',
        'missing_signage': 'Missing Signs',
        'other': 'Other'
      };
      return names[value] || value;
    }

    // Form validation
    function setupFormValidation() {
      const form = document.getElementById('reportForm');

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        // Final validation
        if (!validateCurrentStep()) {
          return;
        }

        // Show loading state
        const submitButton = document.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="bi bi-hourglass-split" aria-hidden="true"></i> Submitting...';
        submitButton.disabled = true;

        // Submit form
        setTimeout(() => {
          form.submit();
        }, 1000);
      });
    }

    // Address geocoding with real-time search
    const addressInput = document.getElementById('city_street');
    let geocodeTimer;

    addressInput.addEventListener('input', function () {
      clearTimeout(geocodeTimer);
      
      const query = this.value.trim();
      
      // Clear indicators if input is empty
      if (query.length === 0) {
        hideSearchingIndicator();
        hideLocationError();
        return;
      }
      
      // Start searching after 3 characters
      if (query.length > 2 && map) {
        geocodeTimer = setTimeout(() => {
          geocodeAddress(query);
        }, 300); // Reduced delay for more responsive search
      }
    });

    // Prevent form submission when pressing Enter in address field
    addressInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const query = this.value.trim();
        if (query.length > 2) {
          clearTimeout(geocodeTimer);
          geocodeAddress(query);
        }
      }
    });

    function geocodeAddress(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=il&bounded=1&q=${encodeURIComponent(address)}&limit=1`;

      // Show searching indicator
      showSearchingIndicator();

      fetch(url)
        .then(response => response.json())
        .then(results => {
          hideSearchingIndicator();
          if (results.length > 0) {
            const result = results[0];
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);

            if (map && !isNaN(lat) && !isNaN(lng)) {
              map.setView([lat, lng], 16);
              setLocation(lat, lng, 'geocode');
              hideLocationError(); // Clear any previous errors
            }
          } else {
            // Show "not found" message
            showLocationError(`No results found for "${address}". Try a different search term.`);
          }
        })
        .catch(error => {
          hideSearchingIndicator();
          showLocationError('Search failed. Please check your connection and try again.');
          console.log('Geocoding error:', error);
        });
    }

    function showSearchingIndicator() {
      const searchSpinner = document.getElementById('search-spinner');
      const statusDiv = document.getElementById('location-status');
      
      // Show spinner in input field
      if (searchSpinner) {
        searchSpinner.style.display = 'block';
      }
      
      // Update status indicator
      if (statusDiv) {
        statusDiv.style.display = 'flex';
        const statusIcon = statusDiv.querySelector('.status-icon');
        statusIcon.className = 'status-icon status-pending';
        statusIcon.innerHTML = '<i class="bi bi-search" aria-hidden="true"></i>';
        statusDiv.querySelector('span').textContent = 'Searching location...';
      }
    }

    function hideSearchingIndicator() {
      const searchSpinner = document.getElementById('search-spinner');
      
      // Hide spinner in input field
      if (searchSpinner) {
        searchSpinner.style.display = 'none';
      }
      
      // Status will be updated by setLocation function when location is found
    }
  </script>
</body>

</html>